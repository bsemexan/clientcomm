<% include header-base %>
<% include header-navbar %>

<style type="text/css">
	.contents {
		background-color: #898989;
	}
</style>

<% function formatAMPM (date) { %>
<%   var hours = date.getHours(); %>
<%   var minutes = date.getMinutes(); %>
<%   var ampm = hours >= 12 ? 'PM' : 'AM'; %>
<%   hours = hours % 12; %>
<%   hours = hours ? hours : 12; %>
<%   minutes = minutes < 10 ? '0'+minutes : minutes; %>
<%   var strTime = hours + ':' + minutes + ' ' + ampm; %>
<%   return strTime; %>
<% } %>

<% var most_recent_comm = null; %>

<div class="contents">
<div class="msgs">

	<div class="msg-head">

		<% if (convo.open) { %>
			<div class="state-btn">
				<% if (convo.accepted) { %>
					<form method="post" action="/cms/<%= user.cmid %>/cls/<%= cl.clid %>/convos/<%= convo.convid %>/close">
						<input type="submit" class="button" value="Close Conversation">
					</form>
				<% } else { %>
					<form method="post" action="/cms/<%= user.cmid %>/cls/<%= cl.clid %>/convos/<%= convo.convid %>/accept">
						<input type="submit" class="button" value="Accept Conversation">
					</form>
					<form method="post" action="/cms/<%= user.cmid %>/cls/<%= cl.clid %>/convos/<%= convo.convid %>/reject">
						<input type="submit" class="button" value="Reject Conversation">
					</form>
				<% } %>
			</div>
		<% } %>

		<div class="subject">
			<%= convo.subject %>
		</div>
	</div>

	<div class="msg-stream">
		<% for (var i = 0; i < msgs.length; i++) { %>

			<% if (i == msgs.length - 1) { most_recent_comm = msgs[i].value } %>

			<div class="msg <%= msgs[i].inbound ? '' : 'outbound' %>">
				<div class="content">
					<%= msgs[i].content %>
				</div>

				<div class="sub">
					<b><%= msgs[i].name %></b>
					
					<% try { %>
						<% var d = new Date(msgs[i].created) %>
						<%= [d.getMonth()+1, d.getDate()].join("/") + " " + formatAMPM(d) %>
					<% } catch (err) { %>
						Unknown
					<% } %>

					<span class="state">
						<% if (msgs[i].inbound) { %>
							<%= msgs[i].tw_status %>
						<% } else { %>
							sent
						<% } %>
					</span>
				</div>
			</div>

		<% } %>
	</div>

	<div class="msg-resp">
		<% if (convo.open) { %>
			<form method="post">

				<div class="form-row">
					<select name="commid" class="blue-select" required>
						<option value="" selected disabled>Comm Method</option>
						<% for (var i = 0; i < comms.length; i++) { %>
							<option value="<%= comms[i].commid %>" <% if (comms[i].value == most_recent_comm) { %> selected <% } %>>
								<%= comms[i].name + ' (' + comms[i].value + ')' %>
							</option>
						<% } %>
					</select>
				</div>

				<div class="form-row">
					<textarea name="content" rows="5" maxlength="160" placeholder="Write new message here (max length 160 characters)." required></textarea>
				</div>

				<div class="form-row">
					<input type="submit" class="form-submit" value="Submit">
				</div>
			</form>
		</div>

		<% } else { %>
			<div class="closed-msg">
				Can't write new messages. This conversation is closed.
				<div class="form-row">
					<form method="post" action="/cms/<%= user.cmid %>/cls/<%= cl.clid %>/convos/<%= convo.convid %>/open">
						<input type="submit" class="form-submit" value="Restore Convo">
					</form>
				</div>
			</div>
		<% } %>
	</div>

</div>
</div>
<% include footer %>

