<% include header %>


<div class="right-nav">
	<div class="nav-btn">
		<a href="/cms/<%= cm.cmid %>/cls/<%= cl.clid %>">
			<i class="fa fa-reply"></i>
			Client Overview
		</a>
	</div>
</div>

<div class="infoblock">
	<div class="infoblock-label">
		<%= convo.subject %>
	</div>

	<div style="float: right">
		<% if (convo.accepted) { %>
			<form method="post" action="/cms/<%= cm.cmid %>/cls/<%= cl.clid %>/convos/<%= convo.convid %>/close">
				<input type="submit" class="button" value="Close" style="background-color:orange; width: 100px">
			</form>
		<% } %>

		<% if (!convo.accepted) { %>
			<form method="post" action="/cms/<%= cm.cmid %>/cls/<%= cl.clid %>/convos/<%= convo.convid %>/accept">
				<input type="submit" class="button" value="Accept" style="background-color:green; width: 100px">
			</form>
			<form method="post" action="/cms/<%= cm.cmid %>/cls/<%= cl.clid %>/convos/<%= convo.convid %>/reject">
				<input type="submit" class="button" value="Reject" style="background-color:red; width: 100px">
			</form>
		<% } %>
	</div>

	<small>
		<i class="fa fa-clock-o"></i>
		<% if (convo.open) { %>
			Last updated
		<% } else { %>
			Closed on
		<% } %>
		<% try { %>
			<% var upd = new Date(convo.updated) %>
			<%= [upd.getMonth()+1, upd.getDate(), upd.getFullYear()].join("/") + " at " + [upd.getHours(), upd.getMinutes(), upd.getSeconds()].join(':') %>
		<% } catch (err) { %>
			Unknown
		<% } %>
	</small>
</div>




<div class="msg-stream">
	<% for (var i = 0; i < msgs.length; i++) { %>

		<% if (msgs[i].inbound) { %>
			<div class="msg inbound">
				<div class="date">
					<% try { %>
						<% var upd = new Date(msgs[i].created) %>
						<%= [upd.getMonth()+1, upd.getDate(), upd.getFullYear()].join("/") + " at " + [upd.getHours(), upd.getMinutes(), upd.getSeconds()].join(':') %>
					<% } catch (err) { %>
						Unknown
					<% } %>
				</div>

				<div class="content">
					<%= msgs[i].content %>
					<div class="description">
						<%= cl.first %> via <%= msgs[i].name %>
					</div>
				</div>
			</div>

		<% } else { %>
			<div class="msg outbound">
				<div class="date">
					<% try { %>
						<% var upd = new Date(msgs[i].created) %>
						<%= [upd.getMonth()+1, upd.getDate(), upd.getFullYear()].join("/") + " at " + [upd.getHours(), upd.getMinutes(), upd.getSeconds()].join(':') %>
					<% } catch (err) { %>
						Unknown
					<% } %>
				</div>

				<div class="content">
					<%= msgs[i].content %>
					<div class="description">
						via <%= msgs[i].name %>
					</div>
				</div>
			</div>
		<% } %>

	<% } %>

	<div class="response">
		<% if (convo.open) { %>
			<form method="post" action="/cms/<%= cm.cmid %>/cls/<%= cl.clid %>/convos/<%= convo.convid %>">
					<textarea name="content" rows="5" maxlength="160" style="width:100%;" placeholder="(Max length 160 characters)" required></textarea>
					<select name="commid" required>
						<option value="" selected disabled>Comm Method</option>
						<% for (var i = 0; i < comms.length; i++) { %>
							<option value="<%= comms[i].commid %>"><%= comms[i].name %></option>
						<% } %>
					</select>
				<input type="submit" class="button" value="Submit">
			</form>

		<% } else { %>
			<center>
				Can't write new messages. This conversation is closed.
			</center>
		<% } %>
	</div>

</div>

<% if (convo.open) { %>

<% } %>

<% include footer %>
